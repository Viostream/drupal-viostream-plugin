!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("ckeditor5/src/core"),require("ckeditor5/src/widget"),require("ckeditor5/src/ui")):"function"==typeof define&&define.amd?define(["ckeditor5/src/core","ckeditor5/src/widget","ckeditor5/src/ui"],t):"object"==typeof exports?exports.CKEditor5=t(require("ckeditor5/src/core"),require("ckeditor5/src/widget"),require("ckeditor5/src/ui")):(e.CKEditor5=e.CKEditor5||{},e.CKEditor5.viostreamVideo=t(e.CKEditor5.core,e.CKEditor5.widget,e.CKEditor5.ui))}(self,(e,t,i)=>(()=>{"use strict";var o={672(t){t.exports=e},124(e){e.exports=i},492(e){e.exports=t}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var i=r[e]={exports:{}};return o[e](i,i.exports,a),i.exports}a.d=(e,t)=>{for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};a.d(s,{default:()=>b});var n=a(672),d=a(492);class l extends n.Command{execute({videoKey:e,videoTitle:t,videoWidth:i,videoHeight:o}){const r=this.editor;r.model.change(a=>{const s=a.createElement("viostreamVideo",{videoKey:e,videoTitle:t||"",videoWidth:i||"",videoHeight:o||""});r.model.insertObject(s,null,null,{setSelection:"on"})})}refresh(){const e=this.editor.model,t=e.document.selection,i=e.schema.findAllowedParent(t.getFirstPosition(),"viostreamVideo");this.isEnabled=null!==i}}class c extends n.Plugin{static get requires(){return[d.Widget]}static get pluginName(){return"ViostreamVideoEditing"}init(){this._defineSchema(),this._defineConverters(),this.editor.commands.add("insertViostreamVideo",new l(this.editor))}_defineSchema(){this.editor.model.schema.register("viostreamVideo",{inheritAllFrom:"$blockObject",allowAttributes:["videoKey","videoTitle","videoWidth","videoHeight"]})}_defineConverters(){const e=this.editor.conversion;e.for("upcast").elementToElement({view:{name:"viostream-video",attributes:{"data-video-key":!0}},model:(e,{writer:t})=>{const i=e.getAttribute("data-video-key")||"",o=e.getAttribute("data-video-title")||"",r=e.getAttribute("data-video-width")||"",a=e.getAttribute("data-video-height")||"";return t.createElement("viostreamVideo",{videoKey:i,videoTitle:o,videoWidth:r,videoHeight:a})}}),e.for("dataDowncast").elementToElement({model:"viostreamVideo",view:(e,{writer:t})=>{const i=e.getAttribute("videoKey")||"",o=e.getAttribute("videoTitle")||"",r=e.getAttribute("videoWidth")||"",a=e.getAttribute("videoHeight")||"",s={"data-video-key":i,"data-video-title":o};return r&&a&&(s["data-video-width"]=r,s["data-video-height"]=a),t.createContainerElement("viostream-video",s)}}),e.for("editingDowncast").elementToElement({model:"viostreamVideo",view:(e,{writer:t})=>{const i=e.getAttribute("videoKey")||"",o=e.getAttribute("videoTitle")||"",r=e.getAttribute("videoWidth")||"",a=e.getAttribute("videoHeight")||"",s=`https://share.viostream.com/${encodeURIComponent(i)}/thumbnail`;let n="";if(r&&a){const e=parseInt(r,10),t=parseInt(a,10);e>0&&t>0&&(n=e+" Ã— "+t)}const l=t.createContainerElement("div",{class:"viostream-ckeditor-widget","data-video-key":i}),c=t.createRawElement("div",{class:"viostream-ckeditor-preview"},e=>{e.innerHTML='<div class="viostream-ckeditor-preview-inner"><div class="viostream-ckeditor-thumb"><img src="'+(v(s).replace(/'/g,"&#39;")+'" alt="" onerror="this.style.display=\'none\'" /><div class="viostream-ckeditor-play-icon"><svg width="48" height="48" viewBox="0 0 48 48" fill="none"><circle cx="24" cy="24" r="24" fill="rgba(0,0,0,0.6)"/><polygon points="18,12 38,24 18,36" fill="white"/></svg></div></div><div class="viostream-ckeditor-info"><span class="viostream-ckeditor-label">Viostream Video')+(n?' <span class="viostream-ckeditor-dimensions">('+v(n)+")</span>":"")+'</span><span class="viostream-ckeditor-title">'+v(o||i)+"</span></div></div>"});return t.insert(t.createPositionAt(l,0),c),(0,d.toWidget)(l,t,{label:"Viostream video widget"})}})}}function v(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var m=a(124);class u extends n.Plugin{static get pluginName(){return"ViostreamVideoUI"}init(){const e=this.editor;e.ui.componentFactory.add("viostreamVideo",t=>{const i=new m.ButtonView(t);i.set({label:e.t("Viostream Video"),icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M19.976 0.75L0.02 5.289L10.127 19.25L19.976 0.75ZM7.643 12.569V5.375L13.467 8.972L7.643 12.569Z"/></svg>\n',tooltip:!0}),i.on("execute",()=>{this._openBrowser()});const o=e.commands.get("insertViostreamVideo");return o&&i.bind("isEnabled").to(o),i})}_openBrowser(){const e=this.editor,t=e.config.get("viostreamVideo")||{},i=t.searchUrl||"",o=t.detailUrlBase||"";if(!i)return void alert("Viostream API is not configured. Please configure it in admin settings.");const r=document.createElement("div");r.className="viostream-modal-overlay";const a=document.createElement("div");a.className="viostream-modal";const s=document.createElement("div");s.className="viostream-modal-header",s.innerHTML='<h3>Select a Viostream Video</h3><button type="button" class="viostream-modal-close">&times;</button>',a.appendChild(s);const n=document.createElement("div");n.className="viostream-modal-body",n.innerHTML='<div class="viostream-media-browser"><div class="viostream-browser-toolbar"><div class="viostream-search-wrapper"><input type="text" class="form-text viostream-search-input" placeholder="Search videos..." /><button type="button" class="button viostream-search-btn">Search</button></div><div class="viostream-sort-wrapper"><label>Sort by:</label><select class="form-select viostream-sort-select"><option value="CreatedDate-desc">Newest first</option><option value="CreatedDate-asc">Oldest first</option><option value="Title-asc">Title A-Z</option><option value="Title-desc">Title Z-A</option></select></div></div><div class="viostream-browser-status"><span class="viostream-result-count"></span><span class="viostream-loading">Loading...</span></div><div class="viostream-media-grid"></div></div>',a.appendChild(n);const d=document.createElement("div");d.className="viostream-modal-footer",d.innerHTML='<button type="button" class="button viostream-modal-cancel">Cancel</button><button type="button" class="button button--primary viostream-modal-select" disabled>Select Video</button>',a.appendChild(d),r.appendChild(a),document.body.appendChild(r);let l=1,c=null;const v=n.querySelector(".viostream-media-browser"),m=v.querySelector(".viostream-search-input"),u=v.querySelector(".viostream-search-btn"),h=v.querySelector(".viostream-sort-select"),b=v.querySelector(".viostream-media-grid"),y=v.querySelector(".viostream-result-count"),f=v.querySelector(".viostream-loading"),w=d.querySelector(".viostream-modal-select"),k=()=>{document.removeEventListener("keydown",E),r.remove()},E=e=>{"Escape"===e.key&&k()};s.querySelector(".viostream-modal-close").addEventListener("click",k),d.querySelector(".viostream-modal-cancel").addEventListener("click",k),r.addEventListener("click",e=>{e.target===r&&k()}),document.addEventListener("keydown",E),w.addEventListener("click",()=>{if(!c)return;w.disabled=!0,w.textContent="Loading...";const t=o?o.replace("__MEDIA_ID__",encodeURIComponent(c.id)):"",i=(t,i)=>{e.execute("insertViostreamVideo",{videoKey:c.key,videoTitle:c.title,videoWidth:t?String(t):"",videoHeight:i?String(i):""}),k(),e.editing.view.focus()};t?fetch(t,{headers:{Accept:"application/json"}}).then(e=>e.json()).then(e=>{i(e.videoWidth||null,e.videoHeight||null)}).catch(e=>{i(null,null)}):i(null,null)});const V=e=>{l=e||1;const t=h.value.split("-"),o=new URLSearchParams({search:m.value,page:l,page_size:24,sort:t[0],order:t[1]});f.style.display="",c=null,w.disabled=!0,fetch(i+"?"+o.toString(),{headers:{Accept:"application/json"}}).then(async e=>{let t;try{t=await e.json()}catch(e){t={}}if(f.style.display="none",e.ok||403!==e.status){if(!e.ok)return b.innerHTML='<div class="viostream-empty">Error loading videos.</div>',void console.error("Viostream error:",t.error||e.statusText);console.log("[Viostream Debug] Render video results:",t),S(t)}else b.innerHTML='<div class="viostream-not-configured"><div class="viostream-not-configured-icon" aria-hidden="true">&#9888;</div><h3>Viostream API not configured</h3><p>The Viostream API credentials have not been set up.</p><p>An administrator needs to configure the API keys at <strong>Configuration &rarr; Media &rarr; Viostream Settings</strong>.</p></div>'}).catch(e=>{f.style.display="none",b.innerHTML='<div class="viostream-empty">Error loading videos.</div>',console.error("[Viostream Debug] Network or JS error:",e)})},S=e=>{const t=e.items||[],i=e.totalItems||0,o=e.totalPages||0;y.textContent=`Showing ${i} videos`;let r="";0===t.length?r='<div class="viostream-empty">No videos found.</div>':t.forEach(e=>{r+='<div class="viostream-media-card" data-media-id="'+g(e.id||"")+'" data-media-key="'+g(e.key||"")+'" data-media-title="'+g(e.title||"")+'" data-media-thumbnail="'+g(e.thumbnail||"")+'"><div class="viostream-card-thumb">',e.thumbnail?r+='<img src="'+g(e.thumbnail)+'" alt="'+g(e.title||"")+'" loading="lazy" />':r+='<div class="viostream-card-no-thumb"><span>No thumbnail</span></div>',e.duration&&(r+='<span class="viostream-card-duration">'+p(function(e){let t=parseFloat(e);if(isNaN(t)||t<0)return"";t=Math.round(t);const i=t%60,o=Math.floor(t/60)%60,r=Math.floor(t/3600),a=e=>e.toString().padStart(2,"0");if(r>0)return`${r}:${a(o)}:${a(i)}`;return`${o}:${a(i)}`}(e.duration))+"</span>"),r+="</div>",r+='<div class="viostream-card-info">',r+='<h4 class="viostream-card-title">'+p(e.title||"")+"</h4>",r+="</div></div>"}),b.innerHTML=r;const a=v.querySelector(".viostream-pagination");if(a&&a.remove(),o>1){const e=document.createElement("div");e.className="viostream-pagination",e.innerHTML='<button type="button" class="button viostream-page-prev"'+(l<=1?" disabled":"")+'>&laquo; Previous</button><span class="viostream-page-info">Page '+l+" of "+o+'</span><button type="button" class="button viostream-page-next"'+(l>=o?" disabled":"")+">Next &raquo;</button>",v.appendChild(e),e.querySelector(".viostream-page-prev").addEventListener("click",()=>{l>1&&V(l-1)}),e.querySelector(".viostream-page-next").addEventListener("click",()=>{V(l+1)})}const s=b.querySelectorAll(".viostream-media-card");s.forEach(e=>{e.addEventListener("click",()=>{s.forEach(e=>e.classList.remove("is-selected")),e.classList.add("is-selected"),c={id:e.dataset.mediaId,key:e.dataset.mediaKey,title:e.dataset.mediaTitle,thumbnail:e.dataset.mediaThumbnail},w.disabled=!1})})};u.addEventListener("click",()=>V(1)),m.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),V(1))}),h.addEventListener("change",()=>V(1)),m.focus(),V(1)}}function p(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function g(e){return p(e).replace(/'/g,"&#39;")}class h extends n.Plugin{static get requires(){return[c,u]}static get pluginName(){return"ViostreamVideo"}}const b={ViostreamVideo:h};return s=s.default})());