# GitHub Actions CI for Viostream Drupal Module
# (Drupal 10/11, PHP 8.3+, Docker-based coverage)
#
#  - Runs full PHPUnit test suite via docker
#  - Handles coverage reporting via Codecov
#  - Composer installed with --ignore-platform-reqs, matching local
#  - Pushes to Codecov if token is configured (token not required for public repos)

name: CI

on:
  push:
    branches: [main, master]
  pull_request:

defaults:
  run:
    shell: bash

jobs:
  test:
    name: "PHPUnit (Docker, PHP 8.3)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Composer dependencies
        run: |
          docker run --rm -v "$PWD":/app -w /app composer:2 install --ignore-platform-reqs

      - name: Run unit tests
        run: |
          docker run --rm -v "$PWD":/app -w /app php:8.3-cli php vendor/bin/phpunit

      - name: Run unit tests with coverage (pcov)
        run: |
          docker run --rm -v "$PWD":/app -w /app php:8.3-cli sh -c "pecl install pcov && php -dextension=pcov.so -dpcov.enabled=1 vendor/bin/phpunit --coverage-clover=coverage.xml"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          flags: unittests
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }} # Only required for private repos

